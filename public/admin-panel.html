<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Dongtube API</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #ffcc00;
      font-size: 28px;
    }

    .header .user-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
      border: none;
      border-radius: 8px;
      color: #1a1a1a;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 204, 0, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      color: #fff;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 36px;
      color: #ffcc00;
      margin-bottom: 10px;
    }

    .stat-card p {
      color: #aaa;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab.active {
      background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
      color: #1a1a1a;
      border-color: #ffcc00;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 204, 0, 0.1);
    }

    th {
      background: rgba(255, 204, 0, 0.1);
      color: #ffcc00;
      font-weight: bold;
    }

    tr:hover {
      background: rgba(255, 204, 0, 0.05);
    }

    select {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      margin-bottom: 15px;
    }

    input:focus {
      outline: none;
      border-color: #ffcc00;
      background: rgba(255, 255, 255, 0.15);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #fff;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .alert-success {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid rgba(0, 255, 0, 0.3);
      color: #51cf66;
    }

    .alert-error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: #ff6b6b;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #aaa;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-admin {
      background: #ff4444;
      color: #fff;
    }

    .badge-vip {
      background: #ffcc00;
      color: #1a1a1a;
    }

    .badge-user {
      background: #888;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öôÔ∏è Admin Panel</h1>
      <div class="user-info">
        <span id="userEmail">admin@dongtube.com</span>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>

    <div class="stats" id="stats">
      <div class="stat-card">
        <h3 id="totalUsers">-</h3>
        <p>Total Users</p>
      </div>
      <div class="stat-card">
        <h3 id="vipUsers">-</h3>
        <p>VIP Users</p>
      </div>
      <div class="stat-card">
        <h3 id="adminUsers">-</h3>
        <p>Admin Users</p>
      </div>
      <div class="stat-card">
        <h3 id="vipEndpoints">-</h3>
        <p>VIP Endpoints</p>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">üë• Manage Users</div>
      <div class="tab" onclick="switchTab('endpoints')">üîí VIP Endpoints</div>
    </div>

    <div id="usersSection" class="content-section active">
      <div class="card">
        <h2>User Management</h2>
        <div class="loading" id="usersLoading">Loading users...</div>
        <table id="usersTable" style="display:none">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Created</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>

    <div id="endpointsSection" class="content-section">
      <div class="card">
        <h2>Add VIP Endpoint</h2>
        <form id="addEndpointForm">
          <div class="form-group">
            <label for="endpointPath">Endpoint Path</label>
            <input type="text" id="endpointPath" placeholder="/api/route-tiktok (1).js" required>
          </div>
          <div class="form-group">
            <label for="endpointDesc">Description (Optional)</label>
            <input type="text" id="endpointDesc" placeholder="TikTok Downloader - VIP Only">
          </div>
          <button type="submit" class="btn">Add VIP Endpoint</button>
        </form>
      </div>

      <div class="card">
        <h2>VIP Endpoints List</h2>
        <div class="loading" id="endpointsLoading">Loading endpoints...</div>
        <table id="endpointsTable" style="display:none">
          <thead>
            <tr>
              <th>Path</th>
              <th>Description</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="endpointsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let users = [];
    let endpoints = [];

    async function checkAuth() {
      try {
        const response = await fetch('/auth/me');
        const data = await response.json();
        
        if (!response.ok || data.user.role !== 'admin') {
          window.location.href = '/login.html';
          return;
        }

        currentUser = data.user;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        loadStats();
        loadUsers();
        loadEndpoints();
      } catch (error) {
        window.location.href = '/login.html';
      }
    }

    async function loadStats() {
      try {
        const response = await fetch('/admin/stats');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalUsers').textContent = data.stats.totalUsers;
          document.getElementById('vipUsers').textContent = data.stats.vipUsers;
          document.getElementById('adminUsers').textContent = data.stats.adminUsers;
          document.getElementById('vipEndpoints').textContent = data.stats.totalVIPEndpoints;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/admin/users');
        const data = await response.json();
        
        if (data.success) {
          users = data.users;
          renderUsers();
        }
      } catch (error) {
        showError('Failed to load users');
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersBody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.email}</td>
          <td><span class="badge badge-${user.role}">${user.role.toUpperCase()}</span></td>
          <td>${new Date(user.createdAt).toLocaleDateString('id-ID')}</td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('id-ID') : '-'}</td>
          <td>
            <select onchange="changeUserRole('${user.id}', this.value)">
              <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
              <option value="vip" ${user.role === 'vip' ? 'selected' : ''}>VIP</option>
              <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('usersLoading').style.display = 'none';
      document.getElementById('usersTable').style.display = 'table';
    }

    async function changeUserRole(userId, newRole) {
      try {
        const response = await fetch(`/admin/users/${userId}/role`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ role: newRole })
        });

        const data = await response.json();

        if (data.success) {
          showSuccess(`User role updated to ${newRole.toUpperCase()}`);
          loadUsers();
          loadStats();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Failed to update user role');
      }
    }

    async function loadEndpoints() {
      try {
        const response = await fetch('/admin/vip-endpoints');
        const data = await response.json();
        
        if (data.success) {
          endpoints = data.endpoints;
          renderEndpoints();
        }
      } catch (error) {
        showError('Failed to load endpoints');
      }
    }

    function renderEndpoints() {
      const tbody = document.getElementById('endpointsBody');
      tbody.innerHTML = '';

      if (endpoints.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">No VIP endpoints configured</td></tr>';
      } else {
        endpoints.forEach(endpoint => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${endpoint.path}</code></td>
            <td>${endpoint.description || '-'}</td>
            <td><span class="badge badge-vip">${endpoint.requiresVIP ? 'VIP ONLY' : 'PUBLIC'}</span></td>
            <td>${new Date(endpoint.createdAt).toLocaleDateString('id-ID')}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteEndpoint(${endpoint.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('endpointsLoading').style.display = 'none';
      document.getElementById('endpointsTable').style.display = 'table';
    }

    document.getElementById('addEndpointForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const path = document.getElementById('endpointPath').value;
      const description = document.getElementById('endpointDesc').value;

      try {
        const response = await fetch('/admin/vip-endpoints', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path, description, requiresVIP: true })
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('VIP endpoint added successfully');
          document.getElementById('addEndpointForm').reset();
          loadEndpoints();
          loadStats();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Failed to add VIP endpoint');
      }
    });

    async function deleteEndpoint(id) {
      if (!confirm('Are you sure you want to delete this VIP endpoint?')) {
        return;
      }

      try {
        const response = await fetch(`/admin/vip-endpoints/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('VIP endpoint deleted');
          loadEndpoints();
          loadStats();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Failed to delete endpoint');
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tab}Section`).classList.add('active');
    }

    function showSuccess(message) {
      const alert = document.getElementById('successAlert');
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 3000);
    }

    function showError(message) {
      const alert = document.getElementById('errorAlert');
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 3000);
    }

    function logout() {
      fetch('/auth/logout', { method: 'POST' })
        .then(() => {
          window.location.href = '/login.html';
        });
    }

    checkAuth();
  </script>
</body>
</html>
